<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cat√°logo Din√¢mico - Debug</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; }
    .mensagem { text-align: center; margin: 2rem; font-size: 1.2rem; color: #333; }
  </style>
</head>
<body>
  <h1 style="text-align:center;">Teste de Debug do Cat√°logo</h1>
  <div id="mensagem" class="mensagem">Iniciando...</div>
  <pre id="debug" style="white-space: pre-wrap; margin: 1rem; background: #eee; padding: 1rem;"></pre>

  <script>
    const debugEl = document.getElementById('debug');
    const mensagemEl = document.getElementById('mensagem');

    function logDebug(msg) {
      console.log(msg);
      debugEl.textContent += msg + "\n";
    }

    const spreadsheetId = '1yJqq-aL5oUnBtxb93bJy2JwLx3ccwuaoQz_UbHAI5_s';
    const url = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/gviz/tq?tqx=out:json`;

    logDebug("üîç URL de fetch: " + url);
    mensagemEl.textContent = "Buscando planilha...";

    fetch(url)
      .then(res => {
        logDebug("Status da resposta: " + res.status + " " + res.statusText);
        return res.text();
      })
      .then(txt => {
        logDebug("üëç Recebeu resposta de texto. Tamanho: " + txt.length + " caracteres");
        const match = txt.match(/(?<=\().*(?=\);)/s);
        if (!match) throw new Error("‚ö†Ô∏è Formato inesperado no JSON recebido");
        logDebug("üí° JSON detectado dentro do texto.");
        const json = JSON.parse(match[0]);
        logDebug("üéØ JSON.parse executado com sucesso.");
        logDebug("Colunas encontradas: " + JSON.stringify(json.table.cols.map(c => c.label)));
        logDebug("Linhas recebidas: " + json.table.rows.length);

        const cols = json.table.cols.map(c => c.label.toLowerCase());
        const rows = json.table.rows;
        const produtos = rows.map(r => {
          return cols.reduce((o, colName, i) => {
            o[colName] = r.c[i]?.v || '';
            return o;
          }, {});
        });
        logDebug("Produtos mapeados: " + JSON.stringify(produtos, null, 2));

        if (produtos.length > 0 && produtos[0].nome) {
          mensagemEl.textContent = "‚úÖ Produtos carregados com sucesso!";
        } else {
          mensagemEl.textContent = "‚ö†Ô∏è A planilha foi lida, mas sem dados v√°lidos.";
        }
      })
      .catch(err => {
        logDebug("‚ùå Erro no fetch ou parse: " + err.message);
        mensagemEl.textContent = "‚ùå Erro ao carregar os produtos. Veja console/debug.";
      });
  </script>
</body>
</html>
